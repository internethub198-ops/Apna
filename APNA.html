<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>APNA TRADERS - PRO BILLING</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --sat: env(safe-area-inset-top); --sab: env(safe-area-inset-bottom); }
        * { -ms-overflow-style: none; scrollbar-width: none; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        *::-webkit-scrollbar { display: none; }
        body { background: #f1f5f9; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; margin: 0; }
        .glass-header { background: #0f172a; padding-top: calc(0.5rem + var(--sat)); border-radius: 0 0 24px 24px; flex-shrink: 0; z-index: 50; }
        .stock-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; padding: 10px 0; }
        .qty-input { background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; font-weight: 800; text-align: center; font-size: 16px; padding: 10px; width: 100%; outline: none; transition: 0.2s; }
        .qty-input:focus { border-color: #3b82f6; background: white; transform: translateY(-2px); shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .item-card { background: white; border-radius: 20px; padding: 12px; margin-bottom: 8px; border: 1px solid #e2e8f0; }
        main { flex: 1; overflow-y: auto; padding: 12px; -webkit-overflow-scrolling: touch; }
        .app-footer { background: white; padding: 15px; padding-bottom: calc(15px + var(--sab)); border-radius: 28px 28px 0 0; box-shadow: 0 -10px 40px rgba(0,0,0,0.06); flex-shrink: 0; }
        .pay-pill { flex: 1; text-align: center; padding: 12px 0; font-size: 10px; font-weight: 800; border-radius: 12px; background: #f1f5f9; color: #64748b; border: 2px solid transparent; }
        .active-CASH { background: #dcfce7 !important; color: #166534 !important; border-color: #22c55e !important; }
        .active-ONLINE { background: #dbeafe !important; color: #1e40af !important; border-color: #3b82f6 !important; }
        .active-CREDIT { background: #fee2e2 !important; color: #991b1b !important; border-color: #ef4444 !important; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 200; display: none; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(4px); }
        .modal-content { background: white; width: 100%; max-width: 360px; border-radius: 28px; padding: 24px; max-height: 80vh; overflow-y: auto; }
        .hide-discount .d-in { display: none !important; }
        .success-overlay { position: fixed; inset: 0; background: #0f172a; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
    </style>
</head>
<body>

<header class="glass-header px-4 shadow-2xl">
    <div class="max-w-md mx-auto flex justify-between items-center mb-1">
        <div>
            <h1 class="text-[9px] font-black text-blue-400 uppercase tracking-[0.2em]">Apna Traders</h1>
            <p class="text-lg font-black text-white">BILLING <span class="text-[10px] text-slate-500 font-bold" id="next-bill-no">#...</span></p>
        </div>
        <div class="flex gap-2">
            <div class="bg-white/5 px-3 py-1.5 rounded-xl border border-white/10 text-center">
                <p class="text-[7px] font-bold text-blue-300 uppercase">Load</p>
                <p class="text-[12px] font-black text-white" id="header-load">0</p>
            </div>
            <button onclick="openReport()" class="bg-white/5 px-3 py-1.5 rounded-xl border border-green-500/30 text-center active:scale-90 transition-all">
                <p class="text-[7px] font-bold text-green-400 uppercase">Sale Report</p>
                <p class="text-[12px] font-black text-white" id="header-sale">0</p>
            </button>
        </div>
    </div>
    <div id="stock-grid" class="max-w-md mx-auto stock-grid"></div>
</header>

<main class="max-w-md mx-auto w-full">
    <div class="bg-slate-200 p-1 rounded-2xl flex mb-4">
        <button onclick="setMode('sale')" id="t-sale" class="flex-1 py-3 text-[11px] font-black rounded-xl bg-white shadow-sm text-blue-600 uppercase transition-all">Sale Mode</button>
        <button onclick="setMode('load')" id="t-load" class="flex-1 py-3 text-[11px] font-black rounded-xl text-slate-500 uppercase transition-all">Load Stock</button>
    </div>

    <section id="customer-form" class="space-y-2 mb-4">
        <input type="text" id="c-name" placeholder="SHOP NAME / PERSON *" class="qty-input !text-left !px-5 uppercase">
        <input type="tel" id="c-mob" placeholder="MOBILE (UDHAARI) *" class="hidden qty-input !text-left !px-5 !bg-red-50 !border-red-500 !text-red-600" inputmode="tel">
    </section>

    <div id="product-container" class="space-y-3"></div>

    <div id="extra-section" class="mt-4 mb-4">
        <div class="item-card bg-purple-50/50 border-dashed border-2 border-purple-200">
            <p class="text-[10px] font-black text-purple-600 uppercase mb-3 text-center">Extra Case (Free Scheme)</p>
            <div id="extra-chips" class="flex flex-wrap justify-center gap-2 mb-3"></div>
            <input type="number" id="extra-qty" oninput="calculate()" placeholder="Extra Qty" class="qty-input !border-purple-200" inputmode="numeric">
        </div>
    </div>
</main>

<footer class="app-footer">
    <div class="max-w-md mx-auto">
        <div id="pay-area-container" class="flex gap-2 mb-4">
            <button onclick="setPayMode('CASH')" id="p-CASH" class="pay-pill">CASH</button>
            <button onclick="setPayMode('ONLINE')" id="p-ONLINE" class="pay-pill">ONLINE</button>
            <button onclick="setPayMode('CREDIT')" id="p-CREDIT" class="pay-pill">UDHAARI</button>
        </div>
        <div class="flex items-center justify-between gap-4">
            <div class="min-w-[120px]">
                <p class="text-[10px] font-bold text-slate-400 uppercase leading-none mb-1">
                    <span id="total-label">Items</span>: <span id="total-qty-val" class="text-blue-600">0</span>
                </p>
                <p id="total-disc-container" class="text-[10px] font-black text-red-500 uppercase mb-1">Total Disc: ₹<span id="total-disc-val">0</span></p>
                <p class="text-2xl font-black text-slate-900">₹<span id="g-total">0</span></p>
            </div>
            <button onclick="submitData()" id="s-btn" class="flex-grow bg-blue-600 h-14 rounded-2xl font-black text-white uppercase shadow-lg active:scale-95 transition-all">Confirm Bill</button>
        </div>
    </div>
</footer>

<div id="reportModal" class="modal" onclick="closeReport()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div id="report-details"></div>
        <button onclick="closeReport()" class="w-full bg-slate-900 py-4 mt-6 rounded-2xl font-black text-white uppercase text-[10px] tracking-widest shadow-xl">Close Summary</button>
    </div>
</div>

<div id="successOverlay" class="success-overlay">
    <div class="bg-green-500 w-20 h-20 rounded-full flex items-center justify-center mb-4 text-white text-4xl shadow-2xl animate-bounce">✓</div>
    <h2 class="text-white text-xl font-black">RECORD SAVED</h2>
</div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzLiXBidf51vX7TMsOToFgenQVvsZTwn9-J6w5oiTRMyvcoj1Z6UI6sinfX6Wi4UOZ2Mg/exec'; 
    const ITEMS = { 
        "250":{n:"250ml",r:90,cls:"text-blue-600"}, "500":{n:"500ml",r:150,cls:"text-green-600"}, 
        "1000":{n:"1L",r:110,cls:"text-orange-600"}, "2000":{n:"2L",r:120,cls:"text-purple-600"}, 
        "LC250":{n:"LC-250",r:150,cls:"text-cyan-600"}, "LC500":{n:"LC-500",r:130,cls:"text-indigo-600"}, 
        "LC1000":{n:"LC-1L",r:90,cls:"text-rose-600"} 
    };
    
    let mode = 'sale', payMode = null, selectedExtra = null, liveData = {stock:{}, report:{total:0, load:0, cash:0, online:0, credit:0, items:{}, billCount:0}};

    async function fetchData() { 
        try { const resp = await fetch(SCRIPT_URL); liveData = await resp.json(); updateUI(); } catch(e) {} 
    }

    function updateUI() {
        document.getElementById('stock-grid').innerHTML = Object.keys(ITEMS).map(k => `
            <div class="bg-white/5 py-1.5 rounded-lg border border-white/5 text-center">
                <p class="text-[6px] text-slate-500 font-bold mb-0.5">${ITEMS[k].n}</p>
                <p class="text-[11px] font-black text-white">${liveData.stock[k] || 0}</p>
            </div>`).join('');
        document.getElementById('header-sale').innerText = (liveData.report.total || 0).toLocaleString();
        document.getElementById('header-load').innerText = (liveData.report.load || 0);
        document.getElementById('next-bill-no').innerText = "#" + ((liveData.report.billCount || 0) + 1).toString().padStart(3, '0');
    }

    function calculate() {
        let gt = 0, totalQ = 0, totalD = 0;
        for (let k in ITEMS) {
            let q = parseInt(document.getElementById('q-'+k).value) || 0;
            let d = mode === 'sale' ? (parseInt(document.getElementById('d-'+k).value) || 0) : 0;
            let row = (q * ITEMS[k].r) - d;
            
            document.getElementById('t-'+k).innerText = mode === 'sale' ? '₹' + Math.max(0, row).toLocaleString() : 'LOAD: ' + q;
            
            totalQ += q; 
            if(mode === 'sale') { gt += Math.max(0, row); totalD += d; }
        }
        totalQ += parseInt(document.getElementById('extra-qty').value) || 0;
        
        document.getElementById('g-total').innerText = gt.toLocaleString();
        document.getElementById('total-qty-val').innerText = totalQ;
        document.getElementById('total-disc-val').innerText = totalD.toLocaleString();
        
        // Label changes
        document.getElementById('total-label').innerText = mode === 'sale' ? 'Items' : 'Total Load';
        document.getElementById('total-disc-container').style.display = (mode === 'sale' && totalD > 0) ? 'block' : 'none';
    }

    function setMode(m) {
        mode = m;
        document.getElementById('t-sale').className = m==='sale' ? 'flex-1 py-3 text-[11px] font-black rounded-xl bg-white shadow-sm text-blue-600 uppercase' : 'flex-1 py-3 text-[11px] font-black text-slate-500 uppercase';
        document.getElementById('t-load').className = m==='load' ? 'flex-1 py-3 text-[11px] font-black rounded-xl bg-white shadow-sm text-orange-600 uppercase' : 'flex-1 py-3 text-[11px] font-black text-slate-500 uppercase';
        
        document.getElementById('customer-form').style.display = m==='sale' ? 'block' : 'none';
        document.getElementById('extra-section').style.display = m==='sale' ? 'block' : 'none';
        document.getElementById('pay-area-container').style.display = m==='sale' ? 'flex' : 'none';
        
        const sBtn = document.getElementById('s-btn');
        sBtn.style.background = m==='sale' ? '#2563eb' : '#ea580c';
        sBtn.innerText = m==='sale' ? 'Confirm Bill' : 'Confirm Load';
        
        document.getElementById('product-container').classList.toggle('hide-discount', m==='load');
        calculate();
    }

    function openReport() {
        const r = liveData.report || {total:0, load:0, cash:0, online:0, credit:0, items:{}};
        const itemsHtml = Object.keys(ITEMS).map(k => `
            <div class="flex justify-between items-center py-2.5 border-b border-slate-50">
                <span class="text-[10px] font-bold text-slate-500 uppercase">${ITEMS[k].n}</span>
                <span class="text-xs font-black text-slate-800">${r.items[k] || 0} Case</span>
            </div>`).join('');

        document.getElementById('report-details').innerHTML = `
            <div class="text-center mb-6">
                <p class="text-[9px] font-black text-blue-600 uppercase mb-1">Today's Summary</p>
                <h2 class="text-3xl font-black text-slate-800">₹${(r.total || 0).toLocaleString()}</h2>
            </div>
            <div class="grid grid-cols-3 gap-2 mb-6">
                <div class="bg-green-50 p-2 rounded-2xl text-center"><p class="text-[7px] font-bold text-green-600 uppercase">Cash</p><p class="text-[10px] font-black">₹${r.cash || 0}</p></div>
                <div class="bg-blue-50 p-2 rounded-2xl text-center"><p class="text-[7px] font-bold text-blue-600 uppercase">Online</p><p class="text-[10px] font-black">₹${r.online || 0}</p></div>
                <div class="bg-red-50 p-2 rounded-2xl text-center"><p class="text-[7px] font-bold text-red-600 uppercase">Udhaar</p><p class="text-[10px] font-black">₹${r.credit || 0}</p></div>
            </div>
            <div class="bg-slate-50 rounded-2xl p-4">
                <div class="flex justify-between items-center mb-3">
                    <p class="text-[9px] font-black text-slate-400 uppercase">Item Wise Sale</p>
                    <p class="text-[9px] font-black text-orange-600 uppercase">LOAD: ${r.load || 0}</p>
                </div>
                <div class="max-h-48 overflow-y-auto">${itemsHtml}</div>
            </div>`;
        document.getElementById('reportModal').style.display = 'flex';
    }

    function init() {
        const container = document.getElementById('product-container');
        const chipBox = document.getElementById('extra-chips');
        Object.keys(ITEMS).forEach(k => {
            container.innerHTML += `
                <div class="item-card">
                    <div class="flex justify-between items-center mb-3">
                        <p class="font-black text-sm ${ITEMS[k].cls}">${ITEMS[k].n}</p>
                        <p id="t-${k}" class="text-slate-900 font-black text-sm">₹0</p>
                    </div>
                    <div class="flex gap-2">
                        <input type="number" id="q-${k}" oninput="calculate()" placeholder="Qty" class="qty-input" inputmode="numeric">
                        <input type="number" id="d-${k}" oninput="calculate()" placeholder="Disc ₹" class="qty-input d-in !bg-red-50 !text-red-600" inputmode="numeric">
                    </div>
                </div>`;
            chipBox.innerHTML += `<button onclick="selectExtra('${k}')" id="chip-${k}" class="px-3 py-2 rounded-xl bg-white border border-slate-200 font-bold text-[10px] text-slate-400 transition-all">${ITEMS[k].n}</button>`;
        });
        fetchData();
    }

    function setPayMode(m) {
        payMode = m;
        document.querySelectorAll('.pay-pill').forEach(b => b.classList.remove('active-CASH', 'active-ONLINE', 'active-CREDIT'));
        document.getElementById('p-'+m).classList.add('active-'+m);
        document.getElementById('c-mob').classList.toggle('hidden', m !== 'CREDIT');
    }

    function selectExtra(k) {
        selectedExtra = (selectedExtra === k) ? null : k;
        document.querySelectorAll('#extra-chips button').forEach(btn => btn.classList.remove('bg-purple-600', 'text-white', 'border-purple-600'));
        if(selectedExtra) document.getElementById('chip-'+k).classList.add('bg-purple-600', 'text-white', 'border-purple-600');
        calculate();
    }

    async function submitData() {
        const btn = document.getElementById('s-btn');
        if(mode === 'sale' && (!document.getElementById('c-name').value.trim() || !payMode)) { alert("Details missing!"); return; }
        
        btn.disabled = true; btn.innerText = "SAVING...";
        let items = {};
        for(let k in ITEMS) {
            let q = parseInt(document.getElementById('q-'+k).value) || 0;
            if(q > 0) items[k] = {q: q, d: mode==='sale' ? (parseInt(document.getElementById('d-'+k).value) || 0) : 0};
        }
        const extraQty = parseInt(document.getElementById('extra-qty').value) || 0;
        if(selectedExtra && extraQty > 0) {
            if(items[selectedExtra]) items[selectedExtra].q += extraQty;
            else items[selectedExtra] = {q: extraQty, d: 0};
        }

        try {
            await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({
                    type: mode.toUpperCase(),
                    billNo: document.getElementById('next-bill-no').innerText,
                    custName: document.getElementById('c-name').value || "STOCK_LOAD",
                    payMode: payMode || "LOAD",
                    items,
                    total: document.getElementById('g-total').innerText.replace(/,/g,'')
                }),
                mode: 'no-cors'
            });
            document.getElementById('successOverlay').style.display = 'flex';
            setTimeout(() => location.reload(), 1500);
        } catch(e) { alert("Error saving!"); btn.disabled = false; }
    }

    function closeReport() { document.getElementById('reportModal').style.display = 'none'; }
    init();
</script>
</body>
</html>